<!doctype html>
<html lang="en">

<head>
    <title>自定义代码片段列表</title>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="../libs/bootstrap.min.css" crossorigin="anonymous">
    <link rel="stylesheet" href="../libs/font-awesome.min.css">
    <link rel="stylesheet" href="../libs/custom.css">
    <link rel="stylesheet" href="../libs/codemirror.css">
    <link rel="stylesheet" href="../libs/codemirror_night.css">
    <link rel="stylesheet" href="css/customSnippetsList.css">
</head>

<body>
    <div class="container snippetsContainer">
        <div class="row">
            <div class="col-sm-12">
                <!--标签的内容-->
                <div class="tab-content snippetsContent">
                    <div class="tab-pane active" id="tab-common">
                        <h3>通用片段</h3>
                        <p>由插件提供的通用代码片段</p>
                        <div class="row snippetsList commonSnippetsList">
                        </div>
                    </div>
                    <div class="tab-pane" id="tab-custom">
                        <h3>自定义片段</h3>
                        <p>用户自定义代码片段</p>
                        <div class="row snippetsList customSnippetsList">

                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- 新建待办弹窗 -->
        <div class="modal fade" id="addPlanPanel" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
            aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content wrapper">
                    <form>
                        <div class="group">
                            <textarea id="addPlanTextarea" type="textarea" rows="8" required="required"></textarea>
                            <span class="highlight"></span>
                            <span class="bar"></span>
                            <label>添加一个新待办：</label>
                        </div>
                        <div class="btn-box">
                            <button id="savePlan" class="btn btn-primary">确定</button>
                            <button id="closePlanBtn" class="btn btn-danger" data-dismiss="modal">取消</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <!-- 显示待办详情弹窗 -->
        <div class="modal fade" id="addCustomSnippetPanel" tabindex="-1" role="dialog"
            aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content wrapper">
                    <form>
                        <div class="group">
                            <input id="" type="text" placeholder="名称" />
                            <input id="" type="text" placeholder="简介" />
                            <div id="customSnippetTextarea" name="customSnippetTextarea"></div>
                            <!-- <textarea id="customSnippetTextarea" name="customSnippetTextarea" type="textarea" rows="8"
                                required="required"></textarea> -->
                            <!-- <span class="highlight"></span> -->
                            <span class="bar"></span>
                            <label>新增代码片段：</label>
                        </div>
                        <div class="btn-box">
                            <button id="saveNewPlan" class="btn btn-primary">保存</button>
                            <button id="closeNewPlanBtn" class="btn btn-danger" data-dismiss="modal">关闭</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="../libs/jquery.slim.min.js" crossorigin="anonymous"></script>
    <script src="../libs/popper.min.js" crossorigin="anonymous"></script>
    <script src="../libs/bootstrap.min.js" crossorigin="anonymous"></script>
    <script src="../libs/codemirror.js" crossorigin="anonymous"></script>
    <script>
        if (!window.snippetsJson) {
            window.snippetsJson = "$snippetsJson" ? "$snippetsJson" : {}
        }

        function editSnippet(spkey) {
            console.log('编辑' + spkey)
        }

        function deleteSnippet(spkey) {
            console.log('删除' + spkey)
        }
    </script>
    <script>
        // 编辑器设置
        var editor = CodeMirror(document.getElementById("customSnippetTextarea"), {
            mode: "javascript",
            theme: "night",
            indentUnit: 4,
            indentWithTabs: true,
            smartIndent: true,
            extraKeys: {
                "F11": function (cm) {
                    cm.setOption("fullScreen", !cm.getOption("fullScreen"));
                },
                "Esc": function (cm) {
                    if (cm.getOption("fullScreen")) cm.setOption("fullScreen", false);
                }
            }
        });
    </script>
    <script>
        //const vscode = acquireVsCodeApi()

        let snippetsKeys = Object.keys(window.snippetsJson)
        console.log(snippetsKeys)
        let customSnippetsKeys = []
        let commonSnippetsKeys = []
        snippetsKeys.map(snippetKey => {
            if (snippetKey.split("custom_").length > 1) {
                customSnippetsKeys.push({
                    key: snippetKey,
                    val: window.snippetsJson[snippetKey]
                })
            } else {
                commonSnippetsKeys.push({
                    key: snippetKey,
                    val: window.snippetsJson[snippetKey]
                })
            }
        })

        console.log(customSnippetsKeys);
        let addBtn =
            `<div id="addSnippet" class="col-sm-2 snippetsItem addSnippet">
            <img src="../../assets/imgs/add.png" />
        </div>`
        $('.commonSnippetsList').append(addBtn)
        $('#addSnippet').on('click', () => {
            $('#addCustomSnippetPanel').modal({
                backdrop: 'static',
                keyboard: false
            });
        })
        if (commonSnippetsKeys.length > 0) {
            commonSnippetsKeys.map((sp) => {
                console.log(sp)
                let sphtml =
                    `<div class="col-sm-2 snippetsItem">
            <div class="thumbnail">
                <div class="spImg">
                    <img src="../../assets/imgs/pice.jpg" width="100px" height="100px" />
                </div>

                <h6>片段名：${sp.key}</h6>
                <p>快捷命令：${sp.val.prefix}</p>
                <div class="row spItemBtns">
                    <div class="col-sm-6 pd0">
                        <a onclick="editSnippet('${sp.key}')" class="btn btn-primary" role="button">编辑</a>
                    </div>
                    <div class="col-sm-6 pd0">
                        <a onclick="deleteSnippet('${sp.key}')" class="btn btn-danger" role="button">删除</a>
                    </div>
                </div>
                <div class="snippetDescribe">
                    ${sp?.val?.description?sp.val.description:"通用片段描述"}
                </div>
            </div>
        </div>`
                $('.commonSnippetsList').append(sphtml)
            })
        }

        if (customSnippetsKeys.length > 0) {
            customSnippetsKeys.map((sp) => {
                console.log(sp)
                let sphtml =
                    `<div class="col-sm-2 snippetsItem">
            <div class="thumbnail">
                <div class="spImg">
                    <img src="../../assets/imgs/pice.jpg" width="100px" height="100px" />
                </div>

                <h6>片段名：${sp.key.split('custom_')[1]}</h6>
                <p>快捷命令：${sp.val.prefix}</p>
                <div class="row spItemBtns">
                    <div class="col-sm-6 pd0">
                        <a onclick="editSnippet('${sp.key}')" class="btn btn-primary" role="button">编辑</a>
                    </div>
                    <div class="col-sm-6 pd0">
                        <a onclick="deleteSnippet('${sp.key}')" class="btn btn-danger" role="button">删除</a>
                    </div>
                </div>
                <div class="snippetDescribe">
                    ${sp?.val?.description?sp.val.description:"通用片段描述"}
                </div>
            </div>
        </div>`
                $('.customSnippetsList').append(sphtml)
            })
        }

        // addcommonsphtml = ``
        // $('.commonSnippetsList').append(sphtml)

        $('#addPlaneBtn').on('click', (event) => {
            $('#addPlanTextarea').val('')
        })
        $('#savePlan').on('click', () => {
            $('#addPlanePanel').modal({
                backdrop: 'static',
                keyboard: false
            });
            let plan = $('#addPlanTextarea').val()
            if (!plan || plan == "") {
                return
            }
            if (!(window['todoListArr'] instanceof Array)) {
                window['todoListArr'] = []
            }
            window['todoListArr'].push({
                content: plan,
                timestamp: Date.now(),
                id: "TODO_" + Date.now(),
                state: 0
            })
            updateItems()
            postSaveJson()
            $('#closePlanBtn').click()

        })
        // 保存编辑过的TODO
        $('#saveNewPlan').on('click', () => {
            $('#showPlaneDetailPanel').modal({
                backdrop: 'static',
                keyboard: false
            });
            let plan = $('#showPlanTextarea').val()
            if (!plan || plan == "") {
                return
            }
            if (!(window['todoListArr'] instanceof Array)) {
                window['todoListArr'] = []
            }
            let flag = false
            window['todoListArr'].map(item => {
                if (item.id == window.currDetailId) {
                    flag = true
                    item.content = plan
                }
            })
            if (!flag) {
                window['todoListArr'].push({
                    content: plan,
                    timestamp: Date.now(),
                    id: "TODO_" + Date.now(),
                    state: 0
                })
            }

            updateItems()
            postSaveJson()
            $('#closeNewPlanBtn').click()

        })




        function postSaveJson() {
            let newJson = {
                todoList: window.todoListArr,
                completeList: window.completeListArr,
                trash: window.trashArr
            }

            vscode.postMessage({
                command: 'updateTodoList',
                todoJson: newJson
            })
        }

        // 展示详情弹窗
        window.showDetailPanel = function (id) {
            window['todoListArr'].map(item => {
                if (item.id == id) {
                    window.currDetailId = id
                    $('#showPlanTextarea').val(item.content)
                    $('#showPlanDetailPanel').modal('show');
                }
            })
        }

        //完成单项待办
        window.completePlan = function (id) {
            window['todoListArr'].map((item, idx) => {
                if (item.id == id) {
                    let cItem = window['todoListArr'].splice(idx, 1)
                    cItem[0].state = 1
                    window.completeListArr.push(cItem[0])
                    updateItems()
                    postSaveJson()
                }
            })
        }

        // 移除单项待办
        window.deletePlan = function (id) {
            window['todoListArr'].map((item, idx) => {
                if (item.id == id) {
                    let tItem = window['todoListArr'].splice(idx, 1)
                    window.trashArr.push(tItem[0])
                    console.log(tItem[0])
                    updateItems()
                    postSaveJson()
                }
            })
        }

        // 将时间戳转成时间
        function getTimeFormat(timestamp) {
            let time = new Date(timestamp);
            let year = time.getFullYear();
            let month = time.getMonth() + 1;
            let day = time.getDate() < 10 ? "0" + time.getDate() : time.getDate();
            let hour = time.getHours() < 10 ? "0" +
                time.getHours() : time.getHours();
            let minute = time.getMinutes() < 10 ? "0" + time.getMinutes() :
                time.getMinutes();
            let second = time.getSeconds() < 10 ? "0" + time.getSeconds() : time.getSeconds();
            return
            year + "." + month + "." + day + " " + hour + ":" + minute + ":" + second;
        }
    </script>
</body>

</html>